# APIs: Server Side Implementation Notes

_(c) AMWA 2017, CC Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)_

## Cross-Origin Resource Sharing (CORS)

In order to permit web control interfaces to be hosted remotely, all NMOS APIs MUST implement valid CORS HTTP headers in responses, and respond to HTTP pre-flight OPTIONS requests. In order to simplify development, the following headers may be returned in order to remove these restrictions as far as possible. Note that these are very relaxed and may not be suitable for a production deployment.

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, PUT, POST, HEAD, OPTIONS, DELETE
Access-Control-Allow-Headers: Content-Type, Accept
Access-Control-Max-Age: 3600
```

To ensure compatibility, the response 'Access-Control-Allow-Headers' could be set from the request's 'Access-Control-Request-Headers'.

## Use of '.local' Hostnames

Where 'href' or 'host' attributes are specified in the APIs, it is strongly recommended to use either IP addresses or hostnames which are resolvable using unicast DNS. Whilst '.local' hostnames are convenient in a zero-configuration layer 2 network segment, these are not usually resolvable beyond these boundaries. As this specification is intended for use between layer 3 network segments, use of these hostnames may result in Nodes appearing inaccessible.

## Un-initialised Senders and Receivers

When a sender or receiver is first started it may not have all the parameters it needs to operate. For example IP addresses and port numbers may not be set. In this instance:

* Senders and receivers should present sensible default values on transport parameter endpoints. Suggested defaults are given in the relevant schemas. Parameters such as port numbers may have defaults in various RFCs that should be followed. Parameters where no sensible defaults exist, such as source IP address on a receiver, should be set to null.
* Senders that are not configured (for example have a null source IP address value), should return 404 on their active transport file endpoint, until a usable set of parameters has been activated.

## Parameter Sets
Senders and Receiver Connection Management endpoints must support a core parameter set. In addition they may support multicast, FEC and/or RTCP parameter sets. Endpoints must support all parameters in a parameter set, or none at all.

### Receiver Parameter Sets

#### Core Parameters
* `source_ip`
* `interface_ip`
* `destination_port`
* `rtp_enabled`

#### Multicast Parameters
* `multicast_ip`

#### FEC Parameters
* `fec_enabled`
* `fec_destination_ip`
* `fec_mode`
* `fec1D_destination_port`
* `fec2D_destination_port`

#### RTCP Parameters
* `rtcp_enabled`
* `rtcp_destination_ip`
* `rtcp_destination_port`

### Sender Parameter Sets

#### Core Parameters
* `source_ip`
* `destination_ip`
* `source_port`
* `destination_port`
* `rtp_enabled`

#### FEC Parameters
* `fec_enabled`
* `fec_destination_ip`
* `fec_type`
* `fec_mode`
* `fec_block_width`
* `fec_block_height`
* `fec1D_destination_port`
* `fec2D_destination_port`
* `fec1D_source_port`
* `fec2D_source_port`

#### RTCP Parameters
* `rtcp_enabled`
* `rtcp_destination_ip`
* `rtcp_destination_port`
* `rtcp_source_port`

## Use of auto
Many transport parameters in the API may be set to "auto" in the `/staged` endpoint, to imply the sender or receiver should select that parameter for itself. In many cases this is a simple operation, and the behaviour is very clearly defined in the relevant transport parameter schemas. For example a port number may be offset from the RTP port number by a pre-determined value.

In some cases the behaviour is more complex, and may be determined by the vendor. The following sub-sections provide guidance on these more complex cases.

### Sender `source_ip` and Receiver `interface_ip`
These parameters specify the interface binding to use for sending or receiving RTP traffic. Use of `auto` here implies the Device should determine for itself which of its interfaces is the most appropriate to use. In Devices where only one interface is available for media traffic this is trivial. In Devices with multiple media network interfaces Devices may use mechanisms such as routing tables, out-of-band controls or evaluation of loading on the interfaces.

### Sender `destination_ip`
If this parameter is set to auto the sender is expected to automatically select a multicast address to send on. This may be determined by an external network control system, or through technologies such as MADCAP (RFC 2730) or ZMAAP.

## Constraints

### Use of JSON Schema with Constraints

It is strongly recommended that API implementations validate requests received from clients against the JSON schema included in this specification. Where additional constraints are applied by the API using the '/constraints' resource, these restrictions should be merged with the provided JSON schema in order to provide consistent validation.

### Constraining Interfaces

The constraints are used to advertise the available network interfaces on the Device. This is done through use of an `enum` constraint, which contains an array of the available interface IP addresses, and the "auto" option (see [Use of auto](## Use of auto)). For interfaces capable of operating with IPv6 and IPv4 each interface should have two entries containing the interface's IPv4 and IPv6 addresses. Examples are provided in the API raml documentation.

## Behaviour of Media Information
SDP files contain both connection information and media information. When a parameter set is activated with an SDP file present in `data` the receiver should use the media information in the SDP file.

## Staged Requests Precedence

It is possible to make a `PATCH` request to the `/staged` receiver endpoint containing both a transport file and transport parameters. Where the content of the transport file and the transport parameters are not in agreement, the transport parameters take precedence. For example, if a transport file specifies a multicast group address of `232.19.133.29` but the transport parameter `multicast_ip` specified a multicast group of `232.20.44.7` then the receiver should use `232.20.44.7`.

## Interpretation of SDP Files
All senders and receivers should comply with RFC 4566 (Session Description Protocol) when creating and parsing SDP files. Multicast senders and receivers should additionally comply with RFC 4570 (SDP Source Filters). Two examples are given below, showing an SDP file and the transport parameters that would be presented at the `/staged` endpoint by a receiver that has parsed the file.

### Unicast

```
    v=0
    o=- 2890844526 2890842807 IN IP4 10.47.16.5
    s=SDP Example
    c=IN IP4 224.2.17.12/127
    t=2873397496 2873404696
    a=recvonly
    m=video 51372 RTP/AVP 99
    a=rtpmap:99 h263-1998/90000
```

```javascript
transport_params:[
    {
        "source_ip": "10.47.16.5",
        "multicast_ip": null,
        "interface_ip": "auto",
        "destination_port": 51372,
        "rtp_enabled": true
    }
]
```

## Source Specific Multicast

```
    v=0
    o=- 1497010742 1497010742 IN IP4 172.29.226.24
    s=SDP Example
    t=2873397496 2873404696
    m=video 5000 RTP/AVP 103
    c=IN IP4 232.21.21.133/32
    a=source-filter:incl IN IP4 232.21.21.133 172.29.226.24
    a=rtpmap:103 raw/90000
```

```javascript
transport_params:[
    {
        "source_ip": "172.29.226.24",
        "multicast_ip": "232.21.21.133,
        "interface_ip": "auto",
        "destination_port": 5000,
        "rtp_enabled": true
    }
]
```

## Operation with SMPTE 2022-5
SMPTE 2022-5 described RTP streams with forward error correction (FEC), and is supported by the Connection Management Specification. This support take the form if the FEC transport parameter set described in [Parameter Sets](##Parameter Sets). Not that senders have additional parameters used to specify the type of FEC to be used and matrix rows and columns, which are not present on the receiver side. In SMPTE 2022-5 this information is conveyed in the FEC headers, and as such does not need to be conveyed separately in Connection Management.

Connection Management APIs supporting SMPTE 2022-5 must comply with RFC 6364 when creating and interpreting SDP files. Implementors may wish to consider the guidance given in VSF TR-04. An example SDP file from RFC 6364 is shown below, followed by the transport parameters that would be presented on the `/staged` endpoint by a receiver that has parsed the file.

```
        v=0
        o=ali 1122334455 1122334466 IN IP4 fec.example.com
        s=FEC Framework Examples
        t=0 0
        a=group:FEC-FR S1 R1
        m=video 30000 RTP/AVP 100
        c=IN IP4 233.252.0.1/127
        a=rtpmap:100 MP2T/90000
        a=fec-source-flow: id=0
        a=mid:S1
        m=application 30000 UDP/FEC
        c=IN IP4 233.252.0.2/127
        a=fec-repair-flow: encoding-id=10; ss-fssi=n:7,k:5
        a=mid:R1
```

```
transport_params:[
    {
        "source_ip": "172.29.226.24",
        "multicast_ip": "232.21.21.133,
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true,
        "fec_enable": true,
        "fec_mode": "auto",
        "fec1D_destination_port": 30000,
        "fec2D_destination_port": null,
        "fec_destination_ip": 233.252.0.2
    }
]
```

## Operation with SMPTE 2022-7
SMPTE 2022-7 describes redundant streams for RTP connections, and is supported by the Connection Management Specification. This manifests itself in the fact that the JSON which describes constraints and transport parameters resides within an array. Where SMPTE-2022-7 is not supported this array contains only one object. Where SMPTE-2022-7 is supported the array contains two entries. The first entry contains information pertaining to Path 1, the second information pertaining to Path 2.

Where a receiver supports SMPTE 2022-7 but is required to receiver a non-SMPTE 2022-7 stream only the first set of transport parameters should be used, and transport parameters in the SDP file should be mapped onto that first object in the array.

Connection Management APIs supporting SMPTE 2022-7 must comply with RFC 7104 when creating and interpreting SDP files. Implementors may also wish to consider the guidance given in VSF TR-04. The stream listed first in the SDP file should be interpreted as being Path 1, and be populated to the first transport parameter object in `/staged`, with the inverse being true for Path 2.

The three examples given in RFC 7104 are shown below, followed by the transport parameters that would be presented on the `/staged` endpoint by a receiver that has parsed the file.

### Separate Source Addresses

```
       v=0
       o=ali 1122334455 1122334466 IN IP4 dup.example.com
       s=DUP Grouping Semantics
       t=0 0
       m=video 30000 RTP/AVP 100
       c=IN IP4 233.252.0.1/127
       a=source-filter:incl IN IP4 233.252.0.1 198.51.100.1 198.51.100.2
       a=rtpmap:100 MP2T/90000
       a=ssrc:1000 cname:ch1@example.com
       a=ssrc:1010 cname:ch1@example.com
       a=ssrc-group:DUP 1000 1010
       a=mid:Ch1
```

```javascript
transport_params:[
    {
        "source_ip": "198.51.100.1",
        "multicast_ip": "233.252.0.1",
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true
    },{
        "source_ip": "198.51.100.2",
        "multicast_ip": "233.252.0.1",
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true
    }
]
```

### Separate Destination Addresses

```
        v=0
        o=ali 1122334455 1122334466 IN IP4 dup.example.com
        s=DUP Grouping Semantics
        t=0 0
        a=group:DUP S1a S1b
        m=video 30000 RTP/AVP 100
        c=IN IP4 233.252.0.1/127
        a=source-filter:incl IN IP4 233.252.0.1 198.51.100.1
        a=rtpmap:100 MP2T/90000
        a=mid:S1a
        m=video 30000 RTP/AVP 101
        c=IN IP4 233.252.0.2/127
        a=source-filter:incl IN IP4 233.252.0.2 198.51.100.1
        a=rtpmap:101 MP2T/90000
        a=mid:S1b
```

```javascript
transport_params:[
    {
        "source_ip": "198.51.100.1",
        "multicast_ip": "233.252.0.1",
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true
    },{
        "source_ip": "198.51.100.1",
        "multicast_ip": "233.252.0.2",
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true
    }
]
```

### Temporal Redundancy

```
        v=0
        o=ali 1122334455 1122334466 IN IP4 dup.example.com
        s=Delayed Duplication
        t=0 0
        m=video 30000 RTP/AVP 100
        c=IN IP4 233.252.0.1/127
        a=source-filter:incl IN IP4 233.252.0.1 198.51.100.1
        a=rtpmap:100 MP2T/90000
        a=ssrc:1000 cname:ch1a@example.com
        a=ssrc:1010 cname:ch1a@example.com
        a=ssrc-group:DUP 1000 1010
        a=duplication-delay:50
        a=mid:Ch1
```

```javascript
transport_params:[
    {
        "source_ip": "198.51.100.1",
        "multicast_ip": "233.252.0.1",
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true
    },{
        "source_ip": "198.51.100.1",
        "multicast_ip": "233.252.0.1",
        "interface_ip": "auto",
        "destination_port": 30000,
        "rtp_enabled": true
    }
]
```

## Operation with RTCP

RTCP provides various functions to support the operation or RTP, principally QoS reporting. RTCP is defined in Section 6 of RFC 3550, which suggests the next highest odd port after the RTP port should be used for its transmission. Where RTCP and forward error correction are both in use it is recommended that the RTP port be chosen to be even, to satisfy the recommendations of both RFC 3550 and SMPTE 2022-5 without resulting in port collisions.

Senders and receivers supporting RTCP should comply with RFC 3605 when creating and receiving SDP files. An RFC 3605 compliant SDP files are shown below, along with the transport parameters that would be presented on the `/staged` endpoint by a receiver that had just parsed that file.

```

    v=0
    o=- 1497010742 1497010742 IN IP4 172.29.226.24
    s=SDP Example
    t=2873397496 2873404696
    m=video 5000 RTP/AVP 103
    c=IN IP4 232.21.21.133/32
    a=source-filter:incl IN IP4 232.21.21.133 172.29.226.24
    a=rtpmap:103 raw/90000
    a=rtcp:5001 IN IP4 232.21.21.133
```

```javascript
transport_params:[
    {
        "source_ip": "172.29.226.24",
        "multicast_ip": "232.21.21.133,
        "interface_ip": "auto",
        "destination_port": 5000,
        "rtcp_enabled": true
        "rtcp_destination_ip": "172.29.226.24",
        "rtcp_destination_port": 5001
        "rtp_enabled": true
    }
]
```
